<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Encargado/Vendedor - Solicitar</title>
    <!-- Estilos KaiAdmin -->
    <link rel="stylesheet" href="../../../assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../../../assets/css/plugins.min.css" />
    <link rel="stylesheet" href="../../../assets/css/kaiadmin.min.css" />
     <link rel="icon" href="../../../assets/img/InicialLogo.png" type="image/x-icon">
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
  </head>

  <body class="sidebar-mini">
    <div class="wrapper">
      <div class="main-panel">
        <!--Componentes de header y sidebar-->
        <div id="header-placeholder"></div>
        <div id="sidebar-placeholder"></div>

        <div class="container">
          <div class="page-inner">
            <div class="card mt-4">
              <div class="card-header">
                <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-2">
              <div>
                <h4>Mostrando empleados de tu sucursal</h4>
              </div>
             
            </div>
              </div>
              <div class="card-body">

                <div class="row row-demo-grid">
                  <!--EMpleados-->
                </div>

              </div>
            </div>
            
          </div>
        </div>
      </div>
    </div>




    <!-- Scripts KaiAdmin -->
    <script src="../../../assets/js/core/jquery-3.7.1.min.js"></script>
    <script src="../../../assets/js/core/popper.min.js"></script>
    <script src="../../../assets/js/core/bootstrap.min.js"></script>
    <script src="../../../assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
    <script src="../../../assets/js/kaiadmin.min.js"></script>

    <script>
  // Capitaliza la primera letra
  function capitalizar(texto) {
    if (!texto) return "";
    return texto.charAt(0).toUpperCase() + texto.slice(1);
  }

  // Ejecutar cuando el DOM esté listo
  document.addEventListener("DOMContentLoaded", cargarComponentesYEquipo);

  function cargarComponentesYEquipo() {
    // Cargar el header
    fetch("../componentes/header.html")
      .then(res => res.text())
      .then(data => {
        document.getElementById("header-placeholder").innerHTML = data;

        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "../../../index.html";
          return;
        }

        // Obtener perfil del usuario
        fetch("http://127.0.0.1:8000/api/usuarios/perfil/", {
          headers: {
            Authorization: "Bearer " + token,
          },
        })
          .then(res => {
            if (!res.ok) throw new Error("No autorizado");
            return res.json();
          })
          .then(perfil => {
            const nombreElem = document.getElementById("nombreUsuario");
            const rolElem = document.getElementById("rolUsuario");

            if (nombreElem) nombreElem.textContent = perfil.nombre || "Usuario";
            if (rolElem) rolElem.textContent = capitalizar(perfil.rol || "Rol");

            if (perfil.rol !== "encargado") {
              window.location.href = "../../no-autorizado.html";
              return;
            }

            cargarEquipoDesdeAPI();
          })
          .catch(() => {
            window.location.href = "../../../index.html";
          });

        // Logout
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", function (e) {
            e.preventDefault();
            localStorage.removeItem("token");
            window.location.href = "../../../index.html";
          });
        }
      });

    // Cargar sidebar
    fetch("../componentes/sidebar.html")
      .then(res => res.text())
      .then(data => {
        document.getElementById("sidebar-placeholder").innerHTML = data;

        setTimeout(() => {
          document.querySelectorAll(".toggle-sidebar").forEach(btn => {
            btn.addEventListener("click", () => {
              document.body.classList.toggle("sidebar_minimize");
            });
          });

          document.querySelectorAll(".sidebar-link").forEach(link => {
            link.addEventListener("click", () => {
              if (window.innerWidth < 992) {
                document.body.classList.remove("sidebar_minimize");
              }
            });
          });

          document.querySelectorAll(".nav-item").forEach(item => item.classList.remove("active"));
          const path = window.location.pathname.split("/").pop();

          document.querySelectorAll(".sidebar-link").forEach(link => {
            if (link.getAttribute("href") && link.getAttribute("href").includes(path)) {
              link.parentElement.classList.add("active");
            }
          });
        }, 100);
      });
  }

  // Cargar empleados desde vista filtrada por backend
  function cargarEquipoDesdeAPI() {
    const token = localStorage.getItem("token");
    const contenedor = document.querySelector(".row-demo-grid");

    if (!token || !contenedor) return;

    fetch("http://127.0.0.1:8000/api/usuarios/empleados-encargado/", {
      headers: {
        Authorization: "Bearer " + token,
      },
    })
      .then(res => {
        if (!res.ok) throw new Error("Error al obtener empleados");
        return res.json();
      })
      .then(empleados => {
        contenedor.innerHTML = "";

        if (empleados.length === 0) {
          contenedor.innerHTML = "<p class='text-muted'>No hay empleados en tu sucursal.</p>";
          return;
        }

        empleados.forEach(emp => {
          const card = document.createElement("div");
          card.className = "col-xl-4 mb-3";
          card.innerHTML = `
            <div class="card">
              <div class="card-body text-center">
                <h5 class="fw-bold mb-1">${emp.nombre}</h5>
                <p class="mb-1 text-muted">Rol: ${capitalizar(emp.rol)}</p>
                <p class="mb-1 text-muted">Cédula: ${emp.cedula || "No asignada"}</p>
                <p class="mb-2 text-muted">Sucursal: ${
                  emp.sucursal_nombres && emp.sucursal_nombres.length > 0
                    ? emp.sucursal_nombres.join(", ")
                    : "No asignada"
                }</p>
              </div>
            </div>
          `;
          contenedor.appendChild(card);
        });
      })
      .catch(err => {
        console.error("Error al cargar empleados:", err);
        contenedor.innerHTML = "<p class='text-danger'>Hubo un error al cargar los empleados.</p>";
      });
  }
</script>


  </body>
</html>
