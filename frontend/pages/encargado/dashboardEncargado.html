<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard - encargado</title>
    <!-- Estilos KaiAdmin -->
    <link rel="stylesheet" href="../../../assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../../../assets/css/plugins.min.css" />
    <link rel="stylesheet" href="../../../assets/css/kaiadmin.min.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <link rel="icon" href="../../../assets/img/InicialLogo.png" type="image/x-icon">
    <style>
      .dashboard-card {
        border-radius: 0.5rem;
        padding: 1rem 1.2rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 1px 4px rgb(0 0 0 / 0.1);
        background: #fff;
        transition: box-shadow 0.3s ease;
        cursor: default;
        height: 90px; /* altura uniforme */
      }
      .dashboard-card:hover {
        box-shadow: 0 4px 12px rgb(0 0 0 / 0.15);
      }
      .dashboard-icon {
        font-size: 2.2rem;
        padding: 0.6rem;
        border-radius: 50%;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 50px;
        height: 50px;
        flex-shrink: 0;
      }
      .text-success .dashboard-icon {
        background-color: #198754;
      }
      .text-warning .dashboard-icon {
        background-color: #ffc107;
        color: #212529;
      }
      .text-primary .dashboard-icon {
        background-color: #0d6efd;
      }
      .text-danger .dashboard-icon {
        background-color: #dc3545;
      }
      .dashboard-info {
        display: flex;
        flex-direction: column;
      }
      .dashboard-info small {
        font-weight: 600;
        color: #666;
      }
      .dashboard-info .value {
        font-size: 1.5rem;
        font-weight: 700;
      }
    </style>
  </head>
  <body class="sidebar-mini">
    <div class="wrapper">
      <div class="main-panel">
        <!--Componentes de header y sidebar-->
        <div id="header-placeholder"></div>
        <div id="sidebar-placeholder"></div>

        <div class="container">
          <div class="page-inner">
            <div class="card mt-4">
              <div class="card-header">
                <h4>Dashboard de asistencias</h4>
              </div>
              <div class="card-body">
                <!-- Cuadros dashboard con Bootstrap grid -->
                <div class="row g-3 text-center">
                  <div class="col-6 col-md-3">
                    <div class="dashboard-card text-success">
                      <div class="dashboard-icon">
                        <i class="fas fa-users"></i>
                      </div>
                      <div class="dashboard-info">
                        <small>Total de empleados</small>
                        <div class="value">0</div>
                      </div>
                    </div>
                  </div>

                  <div class="col-6 col-md-3">
                    <div class="dashboard-card text-warning">
                      <div class="dashboard-icon">
                        <i class="fas fa-clock"></i>
                      </div>
                      <div class="dashboard-info">
                        <small>Empleados con tardanza</small>
                        <div class="value">0</div>
                      </div>
                    </div>
                  </div>

                  <div class="col-6 col-md-3">
                    <div class="dashboard-card text-primary">
                      <div class="dashboard-icon">
                        <i class="fas fa-check-circle"></i>
                      </div>
                      <div class="dashboard-info">
                        <small>Empleados a tiempo</small>
                        <div class="value">0</div>
                      </div>
                    </div>
                  </div>

                  <div class="col-6 col-md-3">
                    <div class="dashboard-card text-danger">
                      <div class="dashboard-icon">
                        <i class="fas fa-user-slash"></i>
                      </div>
                      <div class="dashboard-info">
                        <small>Empleados ausentes</small>
                        <div class="value">0</div>
                      </div>
                    </div>
                  </div>
                </div>
                <!-- Fin cuadros dashboard -->
              </div>
            </div>

            <div class="card mt-4">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Detalles de asistencia</h5>
                <div>
                  <label class="me-2 mb-0">Total de asistencia:</label>
                  <h5 class="mb-0 d-inline" id="totalAsistencias">0</h5>
                </div>
              </div>


                <div class="table-responsive">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>S.No</th>
                        <th>Nombre</th>
                        <th>Rol</th>
                        <th>Fecha</th>
                        <th>Hora de entrada</th>
                        <th>Hora de salida</th>
                        <th>Estado</th>
                      </tr>
                    </thead>
                    <tbody>
                      
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts KaiAdmin -->
    <script src="../../../assets/js/core/jquery-3.7.1.min.js"></script>
    <script src="../../../assets/js/core/popper.min.js"></script>
    <script src="../../../assets/js/core/bootstrap.min.js"></script>
    <script src="../../../assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
    <script src="../../../assets/js/kaiadmin.min.js"></script>

   <script>
  // Función para capitalizar texto
  function capitalizar(texto) {
    return texto.charAt(0).toUpperCase() + texto.slice(1);
  }

  // Cargar header y actualizar nombre y rol
  fetch("../componentes/header.html")
    .then((res) => res.text())
    .then((data) => {
      document.getElementById("header-placeholder").innerHTML = data;

      const token = localStorage.getItem('token');
      if (token) {
        fetch("http://127.0.0.1:8000/api/usuarios/perfil/", {
          headers: { Authorization: "Bearer " + token }
        })
          .then(res => {
            if (!res.ok) throw new Error("No autorizado");
            return res.json();
          })
          .then(data => {
            const nombreElem = document.getElementById("nombreUsuario");
            const rolElem = document.getElementById("rolUsuario");

            if (nombreElem) nombreElem.textContent = data.nombre || "Usuario";
            if (rolElem) rolElem.textContent = capitalizar(data.rol || "Rol");

            // Validar rol y cargar asistencias si es encargado
            if (data.rol !== "encargado") {
              window.location.href = "../../no-autorizado.html";
              return;
            }

            // Cargar asistencias aquí, sólo si es encargado
            cargarAsistenciasEncargado(token);
          })
          .catch(() => {
            console.error("No autorizado");
            window.location.href = "../../../index.html";
          });
      } else {
        window.location.href = "../../../index.html";
      }

      // Logout
      const logoutBtn = document.getElementById("logoutBtn");
      if (logoutBtn) {
        logoutBtn.addEventListener("click", function (e) {
          e.preventDefault();
          localStorage.removeItem("token");
          window.location.href = "../../../index.html";
        });
      }
    });

  // Cargar sidebar y agregar lógica para toggles y active links
  fetch("../componentes/sidebar.html")
    .then((res) => res.text())
    .then((data) => {
      document.getElementById("sidebar-placeholder").innerHTML = data;
      setTimeout(() => {
        document.querySelectorAll(".toggle-sidebar").forEach((btn) => {
          btn.addEventListener("click", () => {
            document.body.classList.toggle("sidebar_minimize");
          });
        });
        document.querySelectorAll(".sidebar-link").forEach((link) => {
          link.addEventListener("click", () => {
            if (window.innerWidth < 992) {
              document.body.classList.remove("sidebar_minimize");
            }
          });
        });
        document.querySelectorAll(".nav-item").forEach((item) => {
          item.classList.remove("active");
        });
        const path = window.location.pathname.split("/").pop();
        document.querySelectorAll(".sidebar-link").forEach((link) => {
          if (
            link.getAttribute("href") &&
            link.getAttribute("href").includes(path)
          ) {
            link.parentElement.classList.add("active");
          }
        });
      }, 100);
    });

  // Función para cargar asistencias del encargado y mostrar en tabla y dashboard
  function cargarAsistenciasEncargado(token) {
    fetch('http://127.0.0.1:8000/api/usuarios/asistencias/encargado/', {
      headers: {
        Authorization: 'Bearer ' + token
      }
    })
      .then(res => res.json())
      .then(data => {
        // Agrupar por usuario + fecha para combinar entrada y salida
        const registrosAgrupados = {};

        data.forEach(item => {
          const key = item.nombre + item.fecha;
          if (!registrosAgrupados[key]) {
            registrosAgrupados[key] = {
              nombre: item.nombre,
              rol: item.rol,
              fecha: item.fecha,
              entrada: null,
              salida: null,
              estado: ''
            };
          }
          if (item.tipo === 'entrada') {
            registrosAgrupados[key].entrada = item.hora;
          }
          if (item.tipo === 'salida') {
            registrosAgrupados[key].salida = item.hora;
          }
        });

        const registros = Object.values(registrosAgrupados);

        // Totales iniciales
        let totalEmpleados = 0;
        let empleadosTarde = 0;
        let empleadosATiempo = 0;
        let empleadosAusentes = 0;

        // Usuarios únicos para contar empleados totales
        const usuariosUnicos = new Set();

        registros.forEach(r => {
          usuariosUnicos.add(r.nombre);

          if (r.entrada) {
            if (r.salida) {
              // Simplificado: entrada después de 08:15 es tarde
              const horaEntrada = parseTime(r.entrada);
              const limiteTarde = parseTime('08:15:00');
              if (horaEntrada > limiteTarde) {
                r.estado = 'Tarde';
                empleadosTarde++;
              } else {
                r.estado = 'A tiempo';
                empleadosATiempo++;
              }
            } else {
              r.estado = 'En progreso';
              empleadosATiempo++;
            }
          } else {
            r.estado = 'Ausente';
            empleadosAusentes++;
          }
        });

        totalEmpleados = usuariosUnicos.size;

        // Actualizar tarjetas
        document.querySelector('.dashboard-card.text-success .value').textContent = totalEmpleados;
        document.querySelector('.dashboard-card.text-warning .value').textContent = empleadosTarde;
        document.querySelector('.dashboard-card.text-primary .value').textContent = empleadosATiempo;
        document.querySelector('.dashboard-card.text-danger .value').textContent = empleadosAusentes;

        // Renderizar tabla
        const tbody = document.querySelector('table tbody');
        tbody.innerHTML = '';

        registros.forEach((r, i) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${i + 1}.</td>
            <td>${r.nombre}</td>
            <td>${r.rol}</td>
            <td>${r.fecha}</td>
            <td>${r.entrada || '-'}</td>
            <td>${r.salida || '-'}</td>
            <td>${r.estado}</td>
          `;
          tbody.appendChild(tr);
        });

        // Actualizar total asistencia
        document.getElementById('totalAsistencias').textContent = registros.length;
      })
      .catch(err => {
        console.error("Error cargando asistencias encargado:", err);
      });
  }

  // Convertir HH:MM:SS a Date para comparación
  function parseTime(t) {
    const [h, m, s] = t.split(':').map(Number);
    const d = new Date();
    d.setHours(h, m, s || 0, 0);
    return d;
  }
</script>

  </body>
</html>

